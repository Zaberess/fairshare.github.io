<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FairShare</title>
<style>
  :root{ --kyle:#1e6fff; --eloise:#b57edc; --bg:#f7f7f8; --card:#fff; --line:#eee; --text:#111; --muted:#777; --tick:#1a7f37; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10}
  h1{margin:0;font-size:18px}
  .spacer{flex:1}
  .seg{display:flex;background:#f2f3f5;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{border:0;background:transparent;padding:8px 12px;font:inherit}
  .seg .on{background:var(--card);border-left:1px solid var(--line);border-right:1px solid var(--line)}
  .kyle.on{outline:2px solid var(--kyle)}
  .eloise.on{outline:2px solid var(--eloise)}
  main{padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;margin-bottom:12px}
  .group-title{font-weight:600;font-size:14px;opacity:.7;margin:4px 6px 8px;display:flex;justify-content:space-between}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;-webkit-tap-highlight-color:transparent}
  .item + .item{border-top:1px solid #f0f0f0}
  .left{min-width:0}
  .title{font-size:15px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .meta{font-size:12px;color:var(--muted)}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .chip{font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;white-space:nowrap}
  .chip.k{border-color:var(--kyle);color:var(--kyle)}
  .chip.e{border-color:var(--eloise);color:var(--eloise)}
  .tick{width:24px;height:24px;border-radius:50%;border:2px solid #ddd;display:grid;place-items:center;flex:0 0 24px}
  .tick.done{border-color:var(--tick);background:#e9f6ee;color:var(--tick)}
  .toolbar{display:flex;gap:8px;align-items:center;margin:0 0 12px}
  .toggle{appearance:none;width:42px;height:26px;border-radius:999px;background:#ddd;position:relative;outline:0;border:0}
  .toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.15s}
  .toggle:checked{background:#8bd49a}
  .toggle:checked::after{left:19px}
  .footer{text-align:center;color:#999;font-size:12px;padding:10px 0 36px}
  .hidden{display:none}
  .status{background:#fff;border-bottom:1px solid var(--line);padding:8px 12px;font-size:12px;color:#333}
  .status .bad{color:#b00020}
  .status .ok{color:#1a7f37}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<header>
  <h1>FairShare</h1>
  <div class="spacer"></div>
  <div class="seg" role="tablist" aria-label="Choose user">
    <button id="btnKyle" class="kyle on" role="tab" aria-selected="true">Kyle</button>
    <button id="btnEloise" class="eloise" role="tab" aria-selected="false">Eloise</button>
  </div>
</header>

<div class="status" id="status">Checking…</div>

<main>
  <div class="toolbar">
    <label class="row" style="gap:6px;font-size:13px;">
      <input id="hideCompleted" type="checkbox" class="toggle" />
      <span>Hide completed</span>
    </label>
    <div class="spacer"></div>
    <button id="seedBtn" title="Insert two demo chores">Add sample chores</button>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="groups"></div>
  <div class="footer">Tip: tap a chore to mark it as completed by the selected person. Long-press to undo.</div>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

const SUPABASE_URL  = 'https://nrqgdvnqfpjmejjkxjjt.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ycWdkdm5xZnBqbWVqamt4amp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTUxNTUsImV4cCI6MjA3ODM3MTE1NX0.itfW0GiNrY-AotR9MVEcTOCeKv6ENGw155WkD8JPIQ4';

const sb = createClient(SUPABASE_URL, SUPABASE_ANON);
const statusBar  = document.getElementById('status');
const groupsBox  = document.getElementById('groups');
const btnKyle    = document.getElementById('btnKyle');
const btnEloise  = document.getElementById('btnEloise');
const hideCompleted = document.getElementById('hideCompleted');
const refreshBtn = document.getElementById('refreshBtn');
const seedBtn    = document.getElementById('seedBtn');

let currentUser = localStorage.getItem('fs_user') || 'Kyle';
let chores = [];

function setStatus(text, ok=true){ statusBar.innerHTML = ok ? `<span class="ok">✓</span> ${text}` : `<span class="bad">⚠</span> ${text}`; }
function applyUserUI(){ const kOn = currentUser === 'Kyle'; btnKyle.classList.toggle('on', kOn); btnKyle.setAttribute('aria-selected', kOn?'true':'false'); btnEloise.classList.toggle('on', !kOn); btnEloise.setAttribute('aria-selected', !kOn?'true':'false'); }
btnKyle.addEventListener('click', ()=>{ currentUser='Kyle'; localStorage.setItem('fs_user', currentUser); applyUserUI(); });
btnEloise.addEventListener('click', ()=>{ currentUser='Eloise'; localStorage.setItem('fs_user', currentUser); applyUserUI(); });

hideCompleted.checked = localStorage.getItem('fs_hide') === '1';
hideCompleted.addEventListener('change', ()=>{ localStorage.setItem('fs_hide', hideCompleted.checked?'1':'0'); render(chores); });
refreshBtn.addEventListener('click', ()=> { load().catch(e=>setStatus(`JS error: ${e.message}`, false)); });

seedBtn.addEventListener('click', async ()=>{
  const rows = [
    { title:'Test chore', area:'Kitchen', frequency:'daily',  effort:1 },
    { title:'Vacuum',     area:'All Rooms', frequency:'weekly', effort:4 }
  ];
  const { error } = await sb.from('chores').insert(rows);
  if(error){ setStatus(`Insert error: ${error.message}`, false); return; }
  setStatus('Added sample chores. Reloading…');
  await load().catch(e=>setStatus(`JS error: ${e.message}`, false));
});

applyUserUI();

/* ---------- helpers ---------- */
function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function startOfMonth(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setDate(1); return x; }
function startOfQuarter(d){ const x=new Date(d); const q=Math.floor(x.getMonth()/3)*3; x.setHours(0,0,0,0); x.setMonth(q,1); return x; }
function startOfHalf(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setMonth(x.getMonth()<6?0:6,1); return x; }
function startOfYear(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setMonth(0,1); return x; }

function periodStart(freq, now=new Date()){
  switch(freq){
    case 'daily': return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    case 'weekly': return startOfWeek(now);
    case 'monthly': return startOfMonth(now);
    case 'quarterly': return startOfQuarter(now);
    case 'semiannual': return startOfHalf(now);
    case 'annual': return startOfYear(now);
    case 'as_needed': return null;
    default: return null;
  }
}
function isDoneForPeriod(c){
  const doneAt = c.last_completed_at ? new Date(c.last_completed_at) : null;
  if(!doneAt) return false;
  if(c.frequency === 'as_needed'){ const todayStart = periodStart('daily'); return doneAt >= todayStart; }
  const ps = periodStart(c.frequency); return ps ? (doneAt >= ps) : false;
}
function since(ts){
  if(!ts) return '—';
  const d = new Date(ts), now = new Date();
  const diff = Math.floor((now-d)/1000);
  if(diff < 60) return 'just now';
  if(diff < 3600) return `${Math.floor(diff/60)} min ago`;
  if(diff < 86400) return `${Math.floor(diff/3600)} h ago`;
  return d.toLocaleDateString();
}
function groupOrder(freq){ return ['daily','as_needed','weekly','monthly','quarterly','semiannual','annual'].indexOf(freq); }
function groupTitle(freq){ return ({ daily:'Today', as_needed:'As needed', weekly:'This week', monthly:'This month', quarterly:'This quarter', semiannual:'This half-year', annual:'This year' })[freq] || freq; }

/* Normalise a row from DB → what UI expects */
function normaliseRow(r){
  const freq = (r.frequency ?? '').toString().trim().toLowerCase()
    .replace(/\s+/g,'_')           // "as needed" -> "as_needed"
    .replace('semi-annual','semiannual')
    .replace('semi_annual','semiannual');

  return {
    id: r.id,
    title: r.title ?? '',
    area: r.area ?? '',
    frequency: ['daily','as_needed','weekly','monthly','quarterly','semiannual','annual'].includes(freq) ? freq : 'as_needed',
    effort: Number.isFinite(r.effort) ? r.effort : (parseInt(r.effort,10) || null),
    last_completed_at: r.last_completed_at || r.last_completed || r.completed_at || null,
    last_completed_by: r.last_completed_by || r.completed_by || null,
  };
}

function personChip(name){
  if(name === 'Kyle') return '<span class="chip k">Kyle</span>';
  if(name === 'Eloise') return '<span class="chip e">Eloise</span>';
  return '';
}

function render(raw){
  const data = raw.map(normaliseRow);
  chores = data.slice();
  groupsBox.innerHTML = '';
  const byFreq = {};
  for(const c of chores){ (byFreq[c.frequency] ||= []).push(c); }
  const freqs = Object.keys(byFreq).sort((a,b)=>groupOrder(a)-groupOrder(b));

  if(freqs.length === 0){
    groupsBox.innerHTML = '<div class="card"><div class="group-title">No chores found</div><div class="meta">Click “Add sample chores”, or seed the table in Supabase.</div></div>';
    setStatus('Connected, but no rows found.', false);
    return;
  }

  for(const f of freqs){
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('div'); title.className='group-title';
    title.innerHTML = `${groupTitle(f)} <span class="meta">(${byFreq[f].length})</span>`;
    card.appendChild(title);

    const list = byFreq[f].sort((a,b)=> a.title.localeCompare(b.title));
    for(const c of list){
      const done = isDoneForPeriod(c);
      if(hideCompleted.checked && done) continue;

      const row = document.createElement('div'); row.className='item'; row.dataset.id = c.id;
      const left = document.createElement('div'); left.className='left';
      const right = document.createElement('div');

      const nameMeta = c.last_completed_by ? ` • ${c.last_completed_by}` : '';
      const metaLine = `${c.area || '—'} • Effort ${c.effort ?? '—'} • ${since(c.last_completed_at)}${nameMeta}`;

      left.innerHTML = `<div class="title">${c.title}</div>
                        <div class="meta">${metaLine}</div>
                        <div class="chips">${personChip(c.last_completed_by)}</div>`;

      const tick = document.createElement('div'); tick.className='tick' + (done ? ' done':''); tick.innerHTML = done ? '✓' : '';
      right.appendChild(tick);

      row.addEventListener('click', async () => {
        const nowIso = new Date().toISOString();
        const { error } = await sb.from('chores').update({ last_completed_at: nowIso, last_completed_by: currentUser }).eq('id', c.id);
        if(error){ setStatus(`Update error: ${error.message}`, false); alert('Error: '+error.message); return; }
        c.last_completed_at = nowIso; c.last_completed_by = currentUser;
        tick.classList.add('done'); tick.innerHTML = '✓';
        left.querySelector('.meta').textContent = `${c.area || '—'} • Effort ${c.effort ?? '—'} • ${since(c.last_completed_at)} • ${c.last_completed_by}`;
        left.querySelector('.chips').innerHTML = personChip(c.last_completed_by);
        setStatus('Updated ✔');
      }, { passive:true });

      // long-press to undo
      let pressTimer;
      row.addEventListener('touchstart', () => {
        pressTimer = setTimeout(async () => {
          const { error } = await sb.from('chores').update({ last_completed_at: null, last_completed_by: null }).eq('id', c.id);
          if(error){ setStatus(`Undo error: ${error.message}`, false); alert('Error: '+error.message); return; }
          c.last_completed_at = null; c.last_completed_by = null;
          tick.classList.remove('done'); tick.innerHTML = '';
          left.querySelector('.meta').textContent = `${c.area || '—'} • Effort ${c.effort ?? '—'} • —`;
          left.querySelector('.chips').innerHTML = '';
          setStatus('Undone ✔');
        }, 600);
      });
      row.addEventListener('touchend', ()=> clearTimeout(pressTimer));
      row.addEventListener('touchmove', ()=> clearTimeout(pressTimer));

      card.appendChild(row);
    }
    groupsBox.appendChild(card);
  }
  setStatus('Loaded ✔');
}

async function load(){
  const { data, error } = await sb.from('chores')
    .select('*')
    .order('frequency', { ascending: true })
    .order('title', { ascending: true });

  if(error){
    groupsBox.innerHTML = `<div class="card"><div class="group-title">Load error</div><pre>${error.message}</pre></div>`;
    setStatus(`Load error: ${error.message}`, false);
    return;
  }
  render(data);
}

load().catch(err => setStatus(`JS error: ${err.message}`, false));
</script>
</body>
</html>
