<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FairShare</title>
<style>
  :root{
    --kyle:#1e6fff;      /* blue */
    --eloise:#b57edc;    /* lavender */
    --bg:#f7f7f8; --card:#fff; --line:#eee; --text:#111; --muted:#777; --tick:#1a7f37;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10}
  h1{margin:0;font-size:18px}
  .spacer{flex:1}
  .seg{display:flex;background:#f2f3f5;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{border:0;background:transparent;padding:8px 12px;font:inherit}
  .seg .on{background:var(--card);border-left:1px solid var(--line);border-right:1px solid var(--line)}
  .kyle.on{outline:2px solid var(--kyle)}
  .eloise.on{outline:2px solid var(--eloise)}
  main{padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;margin-bottom:12px}
  .group-title{font-weight:600;font-size:14px;opacity:.7;margin:4px 6px 8px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;-webkit-tap-highlight-color:transparent}
  .item + .item{border-top:1px solid #f0f0f0}
  .left{min-width:0}
  .title{font-size:15px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .meta{font-size:12px;color:var(--muted)}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .chip{font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;white-space:nowrap}
  .chip.k{border-color:var(--kyle);color:var(--kyle)}
  .chip.e{border-color:var(--eloise);color:var(--eloise)}
  .tick{width:24px;height:24px;border-radius:50%;border:2px solid #ddd;display:grid;place-items:center;flex:0 0 24px}
  .tick.done{border-color:var(--tick);background:#e9f6ee;color:var(--tick)}
  .toolbar{display:flex;gap:8px;align-items:center;margin:0 0 12px}
  .toggle{appearance:none;width:42px;height:26px;border-radius:999px;background:#ddd;position:relative;outline:0;border:0}
  .toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.15s}
  .toggle:checked{background:#8bd49a}
  .toggle:checked::after{left:19px}
  .footer{text-align:center;color:#999;font-size:12px;padding:10px 0 36px}
  .hidden{display:none}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
<header>
  <h1>FairShare</h1>
  <div class="spacer"></div>
  <div class="seg" role="tablist" aria-label="Choose user">
    <button id="btnKyle" class="kyle on" role="tab" aria-selected="true">Kyle</button>
    <button id="btnEloise" class="eloise" role="tab" aria-selected="false">Eloise</button>
  </div>
</header>

<main>
  <div class="toolbar">
    <label class="row" style="gap:6px;font-size:13px;">
      <input id="hideCompleted" type="checkbox" class="toggle" />
      <span>Hide completed</span>
    </label>
    <div class="spacer"></div>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="groups"></div>
  <div class="footer">Tip: tap a chore to mark it as completed by the selected person. Long-press to undo.</div>
</main>

<script>
/* ====== CONFIG: replace with your Supabase project values ====== */
const SUPABASE_URL  = 'https://nrqgdvnqfpjmejjkxjjt.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ycWdkdm5xZnBqbWVqamt4amp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTUxNTUsImV4cCI6MjA3ODM3MTE1NX0.itfW0GiNrY-AotR9MVEcTOCeKv6ENGw155WkD8JPIQ4';
/* =============================================================== */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const groupsBox = document.getElementById('groups');
const btnKyle = document.getElementById('btnKyle');
const btnEloise = document.getElementById('btnEloise');
const hideCompleted = document.getElementById('hideCompleted');
const refreshBtn = document.getElementById('refreshBtn');

const USERS = ['Kyle','Eloise'];
let currentUser = localStorage.getItem('fs_user') || 'Kyle';
let chores = [];

function applyUserUI(){
  const kOn = currentUser === 'Kyle';
  btnKyle.classList.toggle('on', kOn);
  btnKyle.setAttribute('aria-selected', kOn ? 'true':'false');
  btnEloise.classList.toggle('on', !kOn);
  btnEloise.setAttribute('aria-selected', !kOn ? 'true':'false');
}
btnKyle.addEventListener('click', ()=>{ currentUser='Kyle'; localStorage.setItem('fs_user', currentUser); applyUserUI(); });
btnEloise.addEventListener('click', ()=>{ currentUser='Eloise'; localStorage.setItem('fs_user', currentUser); applyUserUI(); });

hideCompleted.checked = localStorage.getItem('fs_hide') === '1';
hideCompleted.addEventListener('change', ()=>{ localStorage.setItem('fs_hide', hideCompleted.checked?'1':'0'); render(chores); });
refreshBtn.addEventListener('click', ()=> load());

applyUserUI();

function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function startOfMonth(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setDate(1); return x; }
function startOfQuarter(d){ const x=new Date(d); x.setHours(0,0,0,0); const q=Math.floor(x.getMonth()/3)*3; x.setMonth(q,1); return x; }
function startOfHalf(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setMonth(x.getMonth()<6?0:6,1); return x; }
function startOfYear(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setMonth(0,1); return x; }

function periodStart(freq, now=new Date()){
  switch(freq){
    case 'daily': return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    case 'weekly': return startOfWeek(now);
    case 'monthly': return startOfMonth(now);
    case 'quarterly': return startOfQuarter(now);
    case 'semiannual': return startOfHalf(now);
    case 'annual': return startOfYear(now);
    case 'as_needed': return null;
    default: return null;
  }
}
function isDoneForPeriod(c){
  if(!c.last_completed_at) return false;
  const doneAt = new Date(c.last_completed_at);
  if(c.frequency === 'as_needed'){
    const todayStart = periodStart('daily');
    return doneAt >= todayStart;
  }
  const ps = periodStart(c.frequency);
  return ps ? (doneAt >= ps) : false;
}
function since(ts){
  if(!ts) return '—';
  const d = new Date(ts), now = new Date();
  const diff = Math.floor((now-d)/1000);
  if(diff < 60) return 'just now';
  if(diff < 3600) return `${Math.floor(diff/60)} min ago`;
  if(diff < 86400) return `${Math.floor(diff/3600)} h ago`;
  return d.toLocaleDateString();
}
function groupOrder(freq){
  return ['daily','as_needed','weekly','monthly','quarterly','semiannual','annual'].indexOf(freq);
}
function groupTitle(freq){
  return ({
    daily:'Today',
    as_needed:'As needed',
    weekly:'This week',
    monthly:'This month',
    quarterly:'This quarter',
    semiannual:'This half-year',
    annual:'This year'
  })[freq] || freq;
}

function personChip(name){
  if(name === 'Kyle') return '<span class="chip k">Kyle</span>';
  if(name === 'Eloise') return '<span class="chip e">Eloise</span>';
  return '';
}

function render(data){
  chores = data.slice(); // keep
  groupsBox.innerHTML = '';
  const byFreq = {};
  for(const c of chores){
    (byFreq[c.frequency] ||= []).push(c);
  }
  const freqs = Object.keys(byFreq).sort((a,b)=>groupOrder(a)-groupOrder(b));

  for(const f of freqs){
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('div'); title.className='group-title'; title.textContent = groupTitle(f);
    card.appendChild(title);

    const list = byFreq[f].sort((a,b)=> a.title.localeCompare(b.title));

    for(const c of list){
      const done = isDoneForPeriod(c);
      if(hideCompleted.checked && done) continue;

      const row = document.createElement('div'); row.className='item'; row.dataset.id = c.id;

      const left = document.createElement('div'); left.className='left';
      const right = document.createElement('div');

      const nameMeta = c.last_completed_by ? ` • ${c.last_completed_by}` : '';
      const metaLine = `${c.area || '—'} • Effort ${c.effort ?? '—'} • ${since(c.last_completed_at)}${nameMeta}`;

      left.innerHTML = `<div class="title">${c.title}</div>
                        <div class="meta">${metaLine}</div>
                        <div class="chips">${personChip(c.last_completed_by)}</div>`;

      const tick = document.createElement('div'); tick.className='tick' + (done ? ' done':''); tick.innerHTML = done ? '✓' : '';
      right.appendChild(tick);

      // Tap to mark done by current user
      row.addEventListener('click', async () => {
        const nowIso = new Date().toISOString();
        const { error } = await sb.from('chores')
          .update({ last_completed_at: nowIso, last_completed_by: currentUser })
          .eq('id', c.id);
        if(error){ alert('Error: '+error.message); return; }
        c.last_completed_at = nowIso;
        c.last_completed_by = currentUser;
        // update UI
        tick.classList.add('done'); tick.innerHTML = '✓';
        left.querySelector('.meta').textContent =
          `${c.area || '—'} • Effort ${c.effort ?? '—'} • ${since(c.last_completed_at)} • ${c.last_completed_by}`;
        left.querySelector('.chips').innerHTML = personChip(c.last_completed_by);
      }, { passive:true });

      // Long-press to undo (clear completion)
      let pressTimer;
      row.addEventListener('touchstart', () => {
        pressTimer = setTimeout(async () => {
          const { error } = await sb.from('chores')
            .update({ last_completed_at: null, last_completed_by: null })
            .eq('id', c.id);
          if(error){ alert('Error: '+error.message); return; }
          c.last_completed_at = null; c.last_completed_by = null;
          tick.classList.remove('done'); tick.innerHTML = '';
          left.querySelector('.meta').textContent =
            `${c.area || '—'} • Effort ${c.effort ?? '—'} • —`;
          left.querySelector('.chips').innerHTML = '';
        }, 600); // hold 600ms
      });
      row.addEventListener('touchend', ()=> clearTimeout(pressTimer));
      row.addEventListener('touchmove', ()=> clearTimeout(pressTimer));

      card.appendChild(row);
    }

    groupsBox.appendChild(card);
  }
}

async function load(){
  const { data, error } = await sb.from('chores')
    .select('*')
    .order('frequency', { ascending: true })
    .order('title', { ascending: true });
  if(error){ groupsBox.innerHTML = '<div class="card">Error loading chores.</div>'; return; }
  render(data);
}

load();
</script>
</body>
</html>
